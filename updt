#!/usr/bin/env bash

# Updt: NixOS Rebuild Helper with Git Change Summary, NVIM Diff, Notifications & Sounds

FLAKE_PATH="/etc/nixos#Overlord"
NIX_DIR="/etc/nixos"
SUCCESS_SOUND="/run/current-system/sw/share/sounds/freedesktop/stereo/complete.oga"
ERROR_SOUND="/run/current-system/sw/share/sounds/freedesktop/stereo/dialog-error.oga"

cd "$NIX_DIR" || {
    notify-send "‚ùå NixOS Updt Error" "Cannot cd into $NIX_DIR"
    exit 1
}

echo "üîç Detecting changes in git‚Ä¶"
CHANGED_FILES=$(git diff --name-only)

if [[ -z "$CHANGED_FILES" ]]; then
    echo "‚Ñπ No changed files. Proceeding without diff."
else
    echo "üìÑ Opening Neovim to show diffs..."
    sleep 1

    # Open all changed files in Neovim diff mode
    nvim -d $(git diff --name-only)
fi

echo "üöÄ Starting nixos-rebuild switch..."
echo "========================================="

if sudo nixos-rebuild switch --show-trace --impure --flake "$FLAKE_PATH" --upgrade; then
    echo
    echo "‚úÖ NixOS rebuild succeeded!"
    notify-send "‚úÖ NixOS Rebuild Done" "System updated successfully!"
    pw-play "$SUCCESS_SOUND"

    echo
    echo "üìå Committing changes to Git..."
    git add -A
    git commit -m "Automatic update: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "üì¶ Changes committed."

else
    echo
    echo "‚ùå NixOS rebuild failed!"
    notify-send "‚ùå NixOS Rebuild Failed" "Check terminal for errors."
    pw-play "$ERROR_SOUND"
    exit 1
fi

